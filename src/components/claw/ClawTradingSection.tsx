import { useState } from "react";
import { Badge } from "@/components/ui/badge";
import { Shield, Target, Zap, Bot, Wallet, TrendingUp } from "lucide-react";
import { useClawTradingAgents, useClawTradingAgentLeaderboard } from "@/hooks/useClawTradingAgents";
import { TradingAgentCard, TradingAgentCardSkeleton, FearGreedGauge } from "@/components/trading";
import { ClawAdminLaunchPanel } from "@/components/claw/ClawAdminLaunchPanel";
import { useIsAdmin } from "@/hooks/useIsAdmin";

export function ClawTradingSection() {
  const [selectedStrategy, setSelectedStrategy] = useState<string | undefined>();
  const [activeTab, setActiveTab] = useState<"active" | "funding" | "top">("active");

  // TODO: pass actual connected wallet address here
  const { isAdmin } = useIsAdmin(null);

  const { data: agents, isLoading } = useClawTradingAgents({
    status: "active",
    strategy: selectedStrategy,
    limit: 12,
  });

  const { data: pendingAgents, isLoading: pendingLoading } = useClawTradingAgents({
    status: "pending",
    limit: 12,
  });

  const { data: leaderboard } = useClawTradingAgentLeaderboard(5);

  const strategies = [
    {
      id: "conservative",
      name: "Conservative",
      icon: Shield,
      color: "hsl(142, 71%, 45%)",
      bgColor: "hsl(142, 71%, 45%, 0.1)",
      borderColor: "hsl(142, 71%, 45%, 0.3)",
      stopLoss: "10%",
      takeProfit: "25%",
      positions: "2 max",
      description: "Lower risk, steady gains. Best for accumulating capital safely.",
    },
    {
      id: "balanced",
      name: "Balanced",
      icon: Target,
      color: "hsl(38, 92%, 50%)",
      bgColor: "hsl(38, 92%, 50%, 0.1)",
      borderColor: "hsl(38, 92%, 50%, 0.3)",
      stopLoss: "20%",
      takeProfit: "50%",
      positions: "3 max",
      description: "Moderate risk-reward. Ideal balance of growth and protection.",
    },
    {
      id: "aggressive",
      name: "Aggressive",
      icon: Zap,
      color: "hsl(var(--claw-primary))",
      bgColor: "hsl(var(--claw-primary) / 0.1)",
      borderColor: "hsl(var(--claw-primary) / 0.3)",
      stopLoss: "30%",
      takeProfit: "100%",
      positions: "5 max",
      description: "High risk, high reward. For those seeking maximum gains. ðŸ¦ž",
    },
  ];

  const tabs = [
    { id: "active" as const, label: "ðŸ¦ž Active" },
    { id: "funding" as const, label: "ðŸ’° Funding", count: pendingAgents?.length },
    { id: "top" as const, label: "ðŸ† Top Performers" },
  ];

  const renderAgents = () => {
    if (activeTab === "active") {
      if (isLoading) return Array.from({ length: 6 }).map((_, i) => <TradingAgentCardSkeleton key={i} />);
      if (!agents?.length) return (
        <div className="col-span-2 text-center py-12" style={{ color: "hsl(var(--claw-muted))" }}>
          <div className="text-3xl mb-2">ðŸ¦ž</div>
          No active trading agents found
        </div>
      );
      return agents.map((a) => <TradingAgentCard key={a.id} agent={a} />);
    }
    if (activeTab === "funding") {
      if (pendingLoading) return Array.from({ length: 4 }).map((_, i) => <TradingAgentCardSkeleton key={i} />);
      if (!pendingAgents?.length) return (
        <div className="col-span-2 text-center py-12" style={{ color: "hsl(var(--claw-muted))" }}>
          <div className="text-3xl mb-2">ðŸ¦ž</div>
          No agents currently in funding phase
        </div>
      );
      return pendingAgents.map((a) => <TradingAgentCard key={a.id} agent={a} />);
    }
    if (activeTab === "top") {
      return leaderboard?.map((a, i) => <TradingAgentCard key={a.id} agent={a as any} rank={i + 1} />);
    }
    return null;
  };

  return (
    <section className="mb-12">
      <h2 className="claw-section-title mb-6 flex items-center gap-3">
        <span className="claw-gradient-text">ðŸ¦ž Trading Agents</span>
      </h2>

      {/* Hero text */}
      <div className="text-center mb-8">
        <p className="text-base max-w-2xl mx-auto mb-4" style={{ color: "hsl(var(--claw-muted))" }}>
          Autonomous AI agents that execute trades using machine learning models.
          Each agent analyzes market data, manages risk with internal SL/TP systems,
          and continuously learns from trade outcomes. ðŸ¦ž
        </p>
        <div className="flex flex-wrap justify-center gap-2 text-xs">
          <div className="claw-badge">
            <span className="font-medium" style={{ color: "hsl(var(--claw-text))" }}>AI Scoring</span> â€” 0-100 token analysis
          </div>
          <div className="claw-badge">
            <span className="font-medium" style={{ color: "hsl(var(--claw-text))" }}>Jupiter DEX</span> â€” Execution layer
          </div>
          <div className="claw-badge">
            <span className="font-medium" style={{ color: "hsl(var(--claw-text))" }}>Internal SL/TP</span> â€” Risk management
          </div>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
        {[
          { label: "Active Agents", value: agents?.length || 0, variant: "red" },
          { label: "Total Profit (SOL)", value: agents?.reduce((s, a) => s + (a.total_profit_sol || 0), 0).toFixed(2) || "0", variant: "teal" },
          { label: "Total Trades", value: agents?.reduce((s, a) => s + (a.total_trades || 0), 0) || 0, variant: "red" },
          { label: "Avg Win Rate", value: `${agents?.length ? (agents.reduce((s, a) => s + (a.win_rate || 0), 0) / agents.length).toFixed(1) : "0"}%`, variant: "teal" },
        ].map((s, i) => (
          <div key={i} className="claw-card p-4 text-center">
            <div className={`claw-stat-value ${s.variant}`}>{s.value}</div>
            <div className="claw-stat-label">ðŸ¦ž {s.label}</div>
          </div>
        ))}
      </div>

      {/* Strategy Selection */}
      <div className="claw-card p-5 mb-6">
        <h3 className="font-bold text-sm mb-3 flex items-center gap-2" style={{ color: "hsl(var(--claw-text))" }}>
          <Target className="h-4 w-4" style={{ color: "hsl(var(--claw-primary))" }} />
          ðŸ¦ž Trading Strategies
        </h3>
        <div className="grid md:grid-cols-3 gap-3">
          {strategies.map((strategy) => {
            const Icon = strategy.icon;
            const isSelected = selectedStrategy === strategy.id;
            return (
              <button
                key={strategy.id}
                onClick={() => setSelectedStrategy(isSelected ? undefined : strategy.id)}
                className="p-3 rounded-lg border text-left transition-all"
                style={{
                  background: isSelected ? strategy.bgColor : "hsl(var(--claw-bg))",
                  borderColor: isSelected ? strategy.borderColor : "hsl(var(--claw-border))",
                }}
              >
                <div className="flex items-center gap-2 mb-1">
                  <Icon className="h-4 w-4" style={{ color: strategy.color }} />
                  <span className="font-semibold text-sm" style={{ color: "hsl(var(--claw-text))" }}>{strategy.name}</span>
                </div>
                <p className="text-xs mb-2" style={{ color: "hsl(var(--claw-muted))" }}>{strategy.description}</p>
                <div className="flex gap-2 flex-wrap">
                  <Badge variant="outline" className="text-[10px]" style={{ borderColor: "hsl(var(--claw-border))", color: "hsl(var(--claw-muted))" }}>
                    SL: {strategy.stopLoss}
                  </Badge>
                  <Badge variant="outline" className="text-[10px]" style={{ borderColor: "hsl(var(--claw-border))", color: "hsl(var(--claw-muted))" }}>
                    TP: {strategy.takeProfit}
                  </Badge>
                  <Badge variant="outline" className="text-[10px]" style={{ borderColor: "hsl(var(--claw-border))", color: "hsl(var(--claw-muted))" }}>
                    {strategy.positions}
                  </Badge>
                </div>
              </button>
            );
          })}
        </div>
      </div>

      <div className="grid lg:grid-cols-3 gap-6">
        {/* Main Content */}
        <div className="lg:col-span-2">
          {/* Tabs */}
          <div className="flex gap-2 mb-4 flex-wrap">
            {tabs.map((tab) => (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id)}
                className={`claw-tab ${activeTab === tab.id ? "active" : ""}`}
              >
                {tab.label}
                {tab.count ? (
                  <span className="ml-1.5 px-1.5 py-0.5 text-[10px] rounded-full" style={{ background: "hsl(var(--claw-primary) / 0.2)", color: "hsl(var(--claw-primary))" }}>
                    {tab.count}
                  </span>
                ) : null}
              </button>
            ))}
          </div>

          {activeTab === "funding" && (
            <div className="mb-4 p-3 rounded-lg" style={{ background: "hsl(38, 92%, 50%, 0.1)", border: "1px solid hsl(38, 92%, 50%, 0.2)" }}>
              <p className="text-sm" style={{ color: "hsl(38, 92%, 50%)" }}>
                <Wallet className="h-4 w-4 inline mr-2" />
                ðŸ¦ž These agents are accumulating trading capital from swap fees. Trading activates at 0.5 SOL.
              </p>
            </div>
          )}

          <div className="grid sm:grid-cols-2 gap-4">
            {renderAgents()}
          </div>
        </div>

        {/* Sidebar */}
        <div className="space-y-4">
          <FearGreedGauge />

          {/* Admin Launch Panel or Info */}
          {isAdmin ? (
            <ClawAdminLaunchPanel />
          ) : (
            <div className="claw-card p-5" style={{ borderColor: "hsl(var(--claw-primary) / 0.3)" }}>
              <h3 className="font-bold text-sm mb-2 flex items-center gap-2" style={{ color: "hsl(var(--claw-text))" }}>
                <Wallet className="h-4 w-4" style={{ color: "hsl(var(--claw-primary))" }} />
                ðŸ¦ž Claw Trading Agents
              </h3>
              <p className="text-xs" style={{ color: "hsl(var(--claw-muted))" }}>
                Agents are launched by admins and available for bidding. Place bids to take ownership and earn fees! ðŸ¦ž
              </p>
            </div>
          )}

          {/* Technical Architecture */}
          <div className="claw-card p-4">
            <h3 className="font-bold text-xs mb-3 flex items-center gap-2" style={{ color: "hsl(var(--claw-text))" }}>
              <Zap className="h-4 w-4" style={{ color: "hsl(var(--claw-secondary))" }} />
              ðŸ¦ž Technical Architecture
            </h3>
            <div className="space-y-2">
              {[
                { title: "Token Scoring Engine", desc: "Multi-factor: liquidity, holders, age, momentum, narrative, volume" },
                { title: "Risk Management", desc: "Internal SL/TP monitoring every 60s via Jupiter" },
                { title: "Capital Flow", desc: "50% swap fees â†’ encrypted trading wallet. Activates at 0.5 SOL" },
              ].map((item, i) => (
                <div key={i} className="p-2 rounded-lg" style={{ background: "hsl(var(--claw-bg))", border: "1px solid hsl(var(--claw-border))" }}>
                  <div className="font-medium text-xs mb-0.5" style={{ color: "hsl(var(--claw-text))" }}>{item.title}</div>
                  <div className="text-[10px]" style={{ color: "hsl(var(--claw-muted))" }}>{item.desc}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </section>
  );
}
